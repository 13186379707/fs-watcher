# fs-watcher

### **1. 用户层**

用户层的指标与应用程序发起的I/O请求直接相关：

- **读写速率（用户进程）**：
  - 指应用程序发起读写的速率，即用户进程从磁盘读取或向磁盘写入的速度。
  - 这个指标能够直接反映应用程序对存储系统的需求，对于评估应用程序性能至关重要。
- **读写比例（进程级）**：
  - 监测读取操作与写入操作的比例，能够帮助识别工作负载的特性，例如是以读取为主还是写入为主，从而指导优化策略。
- **I/O分层时延（进程级）**：
  - 用户进程在用户态运行时间与在内核态运行时间。
  - 通过监控用户态和内核态的运行时间，可以识别性能瓶颈，了解I/O操作的延迟，帮助优化应用程序的I/O操作。
- **I/O交换百分比（进程级）**：
  - 用户进程因为内存不足而触发的 `swap` 操作的百分比。
  - 监测因内存不足导致的swap操作，可以帮助识别内存压力，优化内存使用，从而提高整体系统性能。

### **2. VFS层 (虚拟文件系统层)**

VFS层负责对文件系统的抽象，因此与文件系统无关的I/O活动的汇总在此进行：

- **文件打开/关闭次数（进程级、文件级）**：
  - 每秒用户请求的文件打开和关闭次数。
  - 如果某些文件打开/关闭的频率过高，证明这些文件的访问效率低下，需要优化其缓存策略。
  - 如果某些文件打开/关闭的频率异常高，可能会造成某种场景下的性能瓶颈。
- **文件缓存命中率（进程级）**：
  - 请求的I/O操作直接从缓存中满足的百分比。
  - 高命中率意味着更快的I/O操作，能显著提升系统整体效率。

### **3. 文件系统层**

在文件系统层，I/O操作与具体的文件系统实现相关：

- **每秒读写操作**：
  - 文件系统层每秒发生的读操作和写操作次数。
- **文件系统元数据更新速率**：
  - 每秒文件系统层中元数据（如inode、目录项等）的读写次数。
- **平均读写大小**：
  - 每次读取或写入的平均数据量。
- **文件系统缓存大小**：
  - 不同文件系统的页缓存、inode 缓存、目录项缓存
- **文件系统脏页数**

### **4. 通用块层**

通用块层是处理与块设备的交互的核心层，在此层发生大量的I/O调度和队列管理：

- **I/O操作类型分布**：
  - 监测不同类型的I/O操作（如同步、异步、随机、顺序）的比例，在某段时间内。

- **IOPS（Input/Output Operations Per Second）（设备级）**：
  - 每秒块设备的I/O操作数量。
- **吞吐量/带宽（Throughput）**：
  - 每秒从块设备读取或写入的数据量，单位为MB/s。
- **I/O访问时延（Latency）**：
  - 每个I/O操作从发出到完成的时间，通常以微秒（us）或毫秒（ms）为单位。

### **5. I/O调度层**

I/O调度层负责对I/O请求进行排序和合并，以优化设备的使用：

- **队列深度（Queue Depth）**：
  - 当前队列中等待的I/O请求数量。
- **当前请求队列长度**：
  - 表示通用块层中正在处理的请求数，通常反映I/O压力。
- **队列满的次数**：
  - 队列达到其最大容量的次数，这可能表明设备负载过重。

- **调度算法性能**：
  - 不同调度算法（如 CFQ、Deadline、Noop）的性能表现。
- **合并请求数量**：
  - 调度层合并的相邻I/O请求数量。
- **调度等待时间**：
  - 请求在调度队列中等待的时间。

### **6. 设备驱动层**

设备驱动层是与硬件直接交互的层，在此层处理设备的具体操作：

- **设备忙碌时间（Utilization，设备利用率）**：
  - 在某段时间内，设备处理I/O请求的时间百分比。
- **饱和度**：
  - 设备在最大负载下还能接受新请求的能力。高饱和度表示设备已经达到负载上限。
- **硬件时延（Hardware Latency）**：
  - 设备硬件层面处理I/O的时间，包括寻道时间和旋转延迟。

### **补充指标**

- **错误率（Error Rate）**：
  - 块设备在I/O操作中的失败或错误次数。
- **重试次数（Retry Count）**：
  - 设备或驱动层面因错误而重试I/O请求的次数。
- **丢弃的I/O请求数**：
  - 由于设备过载或其它原因，被丢弃的I/O请求数量。
- **I/O路径时延分解**：
  - I/O请求在不同路径（主机、网络、存储）的时延细分。可用于分析I/O瓶颈位于何处。
    - IO从应用->内存缓存->块设备层->I/O调度->驱动->交换网络->存储前端->存储cache->RAID组->磁盘 
    - （1）主机侧：应用→内存缓存→块设备层→I/O调度→驱动（内核I/O部分） 
    - （2）网络侧：交换网络（网络部分） 
    - （3）存储侧：存储前端→存储cache→RAID组→磁盘（用户服务部分）



| 层次       | 主要指标                                                     |
| ---------- | ------------------------------------------------------------ |
| 用户层     | 读写速率、读写比例、I/O分层时延、I/O交换百分比               |
| VFS层      | 文件打开/关闭次数、文件缓存命中率、                          |
| 文件系统层 | 每秒读写操作次数、文件系统元数据更新速率、平均读写大小、文件系统缓存大小、文件系统脏页数 |
| 通用块层   | I/O操作类型分布、IOPS、吞吐量/带宽、访问时延                 |
| I/O调度层  | 队列深度、当前请求队列长度、队列满的次数、调度算法性能、合并请求数量、调度等待时间 |
| 设备驱动层 | 设备忙碌时间、饱和度、硬件时延                               |
| 补充指标   | 错误率、重试次数、丢弃的I/O请求数、I/O路径时延分解           |

